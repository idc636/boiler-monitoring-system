<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Журнал котельных</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            background: #fff;
        }

        th, td {
            border: 1px solid #999;
            padding: 4px 6px;
            text-align: center;
            font-size: 13px;
        }

        th {
            background: #eaeaea;
        }

        tr.section td {
            background: #d0d0d0;
            font-weight: bold;
            text-align: left;
        }

        td.editable {
            cursor: pointer;
        }

        td.editable:hover {
            background: #ffffcc;
        }

        button {
            padding: 6px 12px;
            margin-left: 6px;
        }
    </style>
</head>
<body>

<header>
    <div>
        Пользователь: <b>{{ user.username }}</b> ({{ user.role }})
    </div>
    <div>
        {% if user.role == 'admin' %}
            <button onclick="addRow()">Добавить</button>
            <button onclick="archive()">Архивировать</button>
        {% endif %}
        <a href="{{ url_for('logout') }}">Выйти</a>
    </div>
</header>

<table>
    <thead>
        <tr>
            <th rowspan="2">№</th>
            <th rowspan="2">Модель</th>
            <th rowspan="2">Год</th>
            <th rowspan="2">Время</th>

            <th colspan="3">Котлы</th>
            <th colspan="3">Сетевые насосы</th>
            <th colspan="3">Подпиточные насосы</th>

            <th colspan="3">Температура</th>
            <th colspan="2">По графику</th>
            <th colspan="2">Давление</th>

            <th rowspan="2">Вода</th>
            <th rowspan="2">Ночь</th>
            <th rowspan="2">День</th>
            <th rowspan="2">Примечания</th>
        </tr>
        <tr>
            <th>Раб</th><th>Рез</th><th>Рем</th>
            <th>Раб</th><th>Рез</th><th>Рем</th>
            <th>Раб</th><th>Рез</th><th>Рем</th>

            <th>Ул</th><th>Подача</th><th>Обратка</th>
            <th>П</th><th>О</th>
            <th>П</th><th>О</th>
        </tr>
    </thead>

    <tbody>
    {% for b in boilers %}
        <tr class="section">
            <td colspan="24">
                {{ b.date }} — Котельная №{{ b.number }},
                {{ b.location }}, {{ b.contact }}
            </td>
        </tr>

        {% for i in range(b.rows) %}
        <tr>
            {% if i == 0 %}
                <td rowspan="{{ b.rows }}">{{ b.number }}</td>
                <td rowspan="{{ b.rows }}" class="editable" data-field="boiler_model">
                    {{ b.boiler_models[0] }}
                </td>
                <td rowspan="{{ b.rows }}" class="editable" data-field="equipment_year">
                    {{ b.years[0].year if b.years }}
                </td>
            {% endif %}

            <td class="editable" data-field="time_interval">{{ b.times[i] }}</td>

            <td class="editable" data-field="boilers_working">{{ b.boilers.work[i] }}</td>
            <td class="editable" data-field="boilers_reserve">{{ b.boilers.reserve[i] }}</td>
            {% if i == 0 %}
                <td rowspan="{{ b.rows }}" class="editable" data-field="boilers_repair">
                    {{ b.boilers.repair }}
                </td>
            {% endif %}

            <td class="editable" data-field="pumps_working">{{ b.network_pumps.work[i] }}</td>
            <td class="editable" data-field="pumps_reserve">{{ b.network_pumps.reserve[i] }}</td>
            {% if i == 0 %}
                <td rowspan="{{ b.rows }}" class="editable" data-field="pumps_repair">
                    {{ b.network_pumps.repair }}
                </td>
            {% endif %}

            <td class="editable" data-field="feed_pumps_working">{{ b.feed_pumps.work[i] }}</td>
            <td class="editable" data-field="feed_pumps_reserve">{{ b.feed_pumps.reserve[i] }}</td>
            {% if i == 0 %}
                <td rowspan="{{ b.rows }}" class="editable" data-field="feed_pumps_repair">
                    {{ b.feed_pumps.repair }}
                </td>
            {% endif %}

            <td class="editable" data-field="temp_outdoor">{{ b.temps[i][0] }}</td>
            <td class="editable" data-field="temp_supply">{{ b.temps[i][1] }}</td>
            <td class="editable" data-field="temp_return">{{ b.temps[i][2] }}</td>

            <td class="editable" data-field="temp_graph_supply">{{ b.graph_temps[i][0] }}</td>
            <td class="editable" data-field="temp_graph_return">{{ b.graph_temps[i][1] }}</td>

            <td class="editable" data-field="pressure_supply">{{ b.pressure[i][0] }}</td>
            <td class="editable" data-field="pressure_return">{{ b.pressure[i][1] }}</td>

            {% if i == 0 %}
                <td rowspan="{{ b.rows }}" class="editable" data-field="water_consumption_daily">
                    {{ b.water_consumption }}
                </td>
                <td rowspan="{{ b.rows }}" class="editable" data-field="staff_night">
                    {{ b.staff.night }}
                </td>
                <td rowspan="{{ b.rows }}" class="editable" data-field="staff_day">
                    {{ b.staff.day }}
                </td>
                <td rowspan="{{ b.rows }}" class="editable" data-field="notes">
                    {{ b.notes }}
                </td>
            {% endif %}
        </tr>
        {% endfor %}
    {% endfor %}
    </tbody>
</table>

<script>
document.querySelectorAll('.editable').forEach(td => {
    td.addEventListener('click', () => {
        if (td.querySelector('input')) return;

        const old = td.innerText;
        const input = document.createElement('input');
        input.value = old;
        td.innerText = '';
        td.appendChild(input);
        input.focus();

        input.addEventListener('blur', () => {
            td.innerText = input.value || old;
        });
    });
});

function addRow() {
    fetch('/add', {method: 'POST'}).then(() => location.reload());
}

function archive() {
    if (!confirm('Архивировать все записи?')) return;
    fetch('/archive', {method: 'POST'})
        .then(r => r.json())
        .then(d => alert(d.message))
        .then(() => location.reload());
}
</script>

</body>
</html>
