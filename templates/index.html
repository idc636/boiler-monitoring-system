<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Учёт работы котельных</title>

<style>
* { font-family: Calibri, Arial, sans-serif; font-size: 11px; }
body { margin: 10px; background: #f5f5f5; }

table {
    border-collapse: collapse;
    width: 100%;
    min-width: 2600px;
    background: white;
}

th, td {
    border: 1px solid #cfcfcf;
    padding: 3px 5px;
    text-align: center;
    white-space: nowrap;
}

th {
    background: #eaeaea;
    font-weight: bold;
    vertical-align: middle;
}

.section {
    background: #d9ead3; /* зелёный как в Excel */
    font-weight: bold;
}

td:first-child, th:first-child {
    position: sticky;
    left: 0;
    background: #f2f2f2;
    z-index: 2;
}

th:first-child { z-index: 3; }

.editable[contenteditable="true"]:focus {
    outline: 2px solid #2a62d8;
    background: #fff;
}
</style>
</head>

<body>

<table>

<thead>

<tr>
    <th colspan="38">{{ records[0].date if records else '' }}</th>
</tr>

<tr>
    <th rowspan="2"></th>
    <th rowspan="2">Марка котла / Марка горелки</th>
    <th rowspan="2">Год оборудования</th>
    <th rowspan="2">Время</th>

    <th colspan="3">Котлы</th>
    <th colspan="3">Сетевые насосы</th>
    <th colspan="3">Подпиточные насосы</th>

    <th colspan="6">Топливные ёмкости</th>
    <th colspan="5">Ёмкости вода</th>

    <th colspan="3">t воды</th>
    <th colspan="2">t воды по графику</th>

    <th rowspan="2">Давление подача</th>
    <th rowspan="2">Давление обратка</th>
    <th rowspan="2">Расход подпиточной воды</th>

    <th colspan="2">Дежурные</th>
    <th rowspan="2">Примечания</th>
</tr>

<tr>
    <th>Работа</th><th>Резерв</th><th>Ремонт</th>
    <th>Работа</th><th>Резерв</th><th>Ремонт</th>
    <th>Работа</th><th>Резерв</th><th>Ремонт</th>

    <th>Всего</th><th>Объём</th><th>Работа</th><th>Резерв</th><th>Остаток</th><th>Расход</th>
    <th>Всего</th><th>Объём</th><th>Работа</th><th>Резерв</th><th>Ремонт</th>

    <th>Улица</th><th>Подача</th><th>Обратка</th>
    <th>Подача</th><th>Обратка</th>
    <th>Ночь</th><th>День</th>
</tr>

</thead>

<tbody>
{% for r in records %}
{% set row = loop.index %}

<tr>
    <!-- 1 столбец -->
    <td>{{ row }}</td>

    <!-- 2 столбец: НАЗВАНИЯ КОТЕЛЬНЫХ -->
    <td
    {% if row in [2,6,11,14] %}
        class="section"
    {% endif %}
    >
        {% if row == 2 %}Котельная №1
        {% elif row == 6 %}Котельная №2
        {% elif row == 11 %}Котельная №3
        {% elif row == 14 %}Котельная №4
        {% else %}
        {{ r.boiler_model }}
        {% endif %}
    </td>

    <!-- остальные колонки -->
    {% for col in [
    'equipment_year','time_interval',
    'boilers_working','boilers_reserve','boilers_repair',
    'pumps_working','pumps_reserve','pumps_repair',
    'feed_pumps_working','feed_pumps_reserve','feed_pumps_repair',
    'fuel_tanks_total','fuel_tank_volume','fuel_tanks_working',
    'fuel_tanks_reserve','fuel_morning_balance','fuel_daily_consumption',
    'water_tanks_total','water_tank_volume','water_tanks_working',
    'water_tanks_reserve','water_tanks_repair',
    'temp_outdoor','temp_supply','temp_return',
    'temp_graph_supply','temp_graph_return',
    'pressure_supply','pressure_return','water_consumption_daily',
    'staff_night','staff_day','notes'
    ] %}
    <td
    {% if user.role=='admin' %}
        contenteditable="true"
        class="editable"
        data-id="{{ r.id }}"
        data-field="{{ col }}"
    {% endif %}
    >
        {{ r[col] }}
    </td>
    {% endfor %}
</tr>
{% endfor %}
</tbody>

</table>

{% if user.role=='admin' %}
<script>
document.querySelectorAll('.editable').forEach(c=>{
 c.addEventListener('blur',()=>{
  fetch('/update',{
   method:'POST',
   headers:{'Content-Type':'application/json'},
   body:JSON.stringify({
    id:c.dataset.id,
    field:c.dataset.field,
    value:c.textContent.trim()
   })
  });
 });
});
</script>
{% endif %}

</body>
</html>
