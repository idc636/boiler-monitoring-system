<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°—É—Ç–æ—á–Ω—ã–π –∂—É—Ä–Ω–∞–ª</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f2f2f2; margin:10px; }
        h3 { text-align:center; margin-bottom:10px; }
        table { border-collapse:collapse; background:#fff; font-size:12px; min-width:2600px; }
        th, td { border:1px solid #000; padding:4px 6px; text-align:center; white-space:nowrap; }
        thead th { background:#d9d9d9; }
        .section { background:#b7d78a; font-weight:bold; text-align:left; }
        .wrap { overflow-x:auto; }
        .editable { cursor:pointer; }
        .editable:hover { background:#e3f2fd; }
        
        /* –î–û–ë–ê–í–õ–ï–ù–û: —Å—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è */
        .mode-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .mode-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        .mode-btn.current {
            background: #4CAF50;
            color: white;
        }
        .mode-btn.archive {
            background: #ffc107;
            color: black;
        }
        .mode-btn:hover {
            opacity: 0.8;
        }
        .date-select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
        }
        .archive-controls {
            display: none;
            margin-left: 15px;
            align-items: center;
        }
        .archive-controls.show {
            display: flex;
        }
    </style>
</head>
<body>
    <h3>–ê–û ¬´–Ø–º–∞–ª–∫–æ–º—É–Ω—ç–Ω–µ—Ä–≥–æ¬ª ‚Äî –°—É—Ç–æ—á–Ω—ã–π –∂—É—Ä–Ω–∞–ª ({{ journal_date }})</h3>
    
    <!-- –î–û–ë–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
    <div class="mode-switch">
        <button class="mode-btn current" onclick="switchMode('current')">
            üü¢ –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        </button>
        <button class="mode-btn archive" onclick="switchMode('archive')">
            üì¶ –ê—Ä—Ö–∏–≤
        </button>
        
        <div class="archive-controls" id="archiveControls">
            <label for="archiveDate">–î–∞—Ç–∞: </label>
            <select class="date-select" id="archiveDate" onchange="loadArchive()">
                {% for d in archive_dates %}
                <option value="{{ d }}" {% if selected_date == d %}selected{% endif %}>
                    {{ d }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="wrap">
        <table>
            <thead>
                <tr>
                    <th rowspan="2">‚Ññ</th>
                    <th rowspan="2">–ú–∞—Ä–∫–∞ –∫–æ—Ç–ª–∞ / –ú–∞—Ä–∫–∞ –≥–æ—Ä–µ–ª–∫–∏</th>
                    <th rowspan="2">–ì–æ–¥ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</th>
                    <th rowspan="2">–í—Ä–µ–º—è</th>
                    <th colspan="3">–ö–æ—Ç–ª—ã</th>
                    <th colspan="3">–°–µ—Ç–µ–≤—ã–µ –Ω–∞—Å–æ—Å—ã</th>
                    <th colspan="3">–ü–æ–¥–ø–∏—Ç–æ—á–Ω—ã–µ –Ω–∞—Å–æ—Å—ã</th>
                    <th colspan="3">t¬∞C –≤–æ–¥—ã</th>
                    <th colspan="2">t¬∞C –≤–æ–¥—ã –ø–æ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–æ–º—É –≥—Ä–∞—Ñ–∏–∫—É</th>
                    <th rowspan="2">–î–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø–æ–¥–∞—á–µ, –∫–≥—Å/—Å–º¬≤</th>
                    <th rowspan="2">–î–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ–±—Ä–∞—Ç–∫–µ, –∫–≥—Å/—Å–º¬≤</th>
                    <th rowspan="2">–†–∞—Å—Ö–æ–¥ –ø–æ–¥–ø–∏—Ç–æ—á–Ω–æ–π –≤–æ–¥—ã –∑–∞ —Å—É—Ç–∫–∏, –º¬≥</th>
                    <th colspan="2">–î–µ–∂—É—Ä–Ω—ã–µ –∫–æ—Ç–µ–ª—å–Ω–æ–π</th>
                    <th rowspan="2">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                </tr>
                <tr>
                    <th>–†–∞–±–æ—Ç–∞ ‚Ññ</th><th>–†–µ–∑–µ—Ä–≤ ‚Ññ</th><th>–†–µ–º–æ–Ω—Ç</th>
                    <th>–†–∞–±–æ—Ç–∞ ‚Ññ</th><th>–†–µ–∑–µ—Ä–≤ ‚Ññ</th><th>–†–µ–º–æ–Ω—Ç</th>
                    <th>–†–∞–±–æ—Ç–∞ ‚Ññ</th><th>–†–µ–∑–µ—Ä–≤ ‚Ññ</th><th>–†–µ–º–æ–Ω—Ç</th>
                    <th>–ù–∞—Ä—É–∂–Ω–∞—è</th><th>–ü–æ–¥–∞—á–∞</th><th>–û–±—Ä–∞—Ç–∫–∞</th>
                    <th>–ü–æ–¥–∞—á–∞</th><th>–û–±—Ä–∞—Ç–∫–∞</th>
                    <th>–ù–æ—á—å</th><th>–î–µ–Ω—å</th>
                </tr>
            </thead>
            <tbody>
                {% for boiler in boilers %}
                {% set boiler_index = loop.index0 %}
                {% set row_idx = 0 %}
                
                <!-- –ö–û–¢–ï–õ–¨–ù–ê–Ø -->
                <tr class="section">
                    <td colspan="24">
                        –ö–æ—Ç–µ–ª—å–Ω–∞—è ‚Ññ{{ boiler.number }} {{ boiler.location }} {{ boiler.contact }}
                    </td>
                </tr>
                
                <!-- –ú–ê–†–ö–ê (—Ü–∏–∫–ª –ø–æ –≤—Ä–µ–º–µ–Ω–∏) -->
                {% for i in range(boiler.rows) %}
                <tr>
                    {% if i == 0 %}
                    <td rowspan="{{ boiler.rows }}">{{ loop.parent.loop.index }}</td>
                    <td rowspan="{{ boiler.rows }}" 
                        {% if mode == 'current' %}
                        class="editable" data-field="boiler_model" data-id="{{ boiler_index * 100 + 1 }}"
                        {% endif %}>
                        {{ boiler.boiler_models[i] }}
                    </td>
                    <td rowspan="{{ boiler.rows }}" 
                        {% if mode == 'current' %}
                        class="editable" data-field="equipment_year" data-id="{{ boiler_index * 100 + 1 }}"
                        {% endif %}>
                        {{ boiler.years[0].year if boiler.years else '' }}
                    </td>
                    {% endif %}
                    
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="time_interval" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.times[i] }}
                    </td>
                    
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="boilers_working" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.boilers.work[i] }}
                    </td>
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="boilers_reserve" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.boilers.reserve[i] }}
                    </td>
                    
                    {% if i == 0 %}
                    <td rowspan="{{ boiler.rows }}" 
                        {% if mode == 'current' %}
                        class="editable" data-field="boilers_repair" data-id="{{ boiler_index * 100 + 1 }}"
                        {% endif %}>
                        {{ boiler.boilers.repair }}
                    </td>
                    {% endif %}
                    
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="pumps_working" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.network_pumps.work[i] }}
                    </td>
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="pumps_reserve" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.network_pumps.reserve[i] }}
                    </td>
                    
                    {% if i == 0 %}
                    <td rowspan="{{ boiler.rows }}" 
                        {% if mode == 'current' %}
                        class="editable" data-field="pumps_repair" data-id="{{ boiler_index * 100 + 1 }}"
                        {% endif %}>
                        {{ boiler.network_pumps.repair }}
                    </td>
                    {% endif %}
                    
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="feed_pumps_working" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.feed_pumps.work[i] }}
                    </td>
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="feed_pumps_reserve" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.feed_pumps.reserve[i] }}
                    </td>
                    
                    {% if i == 0 %}
                    <td rowspan="{{ boiler.rows }}" 
                        {% if mode == 'current' %}
                        class="editable" data-field="feed_pumps_repair" data-id="{{ boiler_index * 100 + 1 }}"
                        {% endif %}>
                        {{ boiler.feed_pumps.repair }}
                    </td>
                    {% endif %}
                    
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="temp_outdoor" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.temps[i][0] }}
                    </td>
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="temp_supply" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.temps[i][1] }}
                    </td>
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="temp_return" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.temps[i][2] }}
                    </td>
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="temp_graph_supply" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.graph_temps[i][0] }}
                    </td>
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="temp_graph_return" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.graph_temps[i][1] }}
                    </td>
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="pressure_supply" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.pressure[i][0] }}
                    </td>
                    <td 
                        {% if mode == 'current' %}
                        class="editable" data-field="pressure_return" data-id="{{ boiler_index * 100 + i + 1 }}"
                        {% endif %}>
                        {{ boiler.pressure[i][1] }}
                    </td>
                    
                    {% if i == 0 %}
                    <td rowspan="{{ boiler.rows }}" 
                        {% if mode == 'current' %}
                        class="editable" data-field="water_consumption_daily" data-id="{{ boiler_index * 100 + 1 }}"
                        {% endif %}>
                        {{ boiler.water_consumption }}
                    </td>
                    <td rowspan="{{ boiler.rows }}" 
                        {% if mode == 'current' %}
                        class="editable" data-field="staff_night" data-id="{{ boiler_index * 100 + 1 }}"
                        {% endif %}>
                        {{ boiler.staff.night }}
                    </td>
                    <td rowspan="{{ boiler.rows }}" 
                        {% if mode == 'current' %}
                        class="editable" data-field="staff_day" data-id="{{ boiler_index * 100 + 1 }}"
                        {% endif %}>
                        {{ boiler.staff.day }}
                    </td>
                    <td rowspan="{{ boiler.rows }}" 
                        {% if mode == 'current' %}
                        class="editable" data-field="notes" data-id="{{ boiler_index * 100 + 1 }}"
                        {% endif %}>
                        {{ boiler.notes }}
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // –î–û–ë–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤
        function switchMode(mode) {
            const url = new URL(window.location.href);
            url.searchParams.set('mode', mode);
            
            if (mode === 'archive') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –¥–∞—Ç—ã
                document.getElementById('archiveControls').classList.add('show');
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç—ã –≤ –∞—Ä—Ö–∏–≤–µ, –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é
                const dateSelect = document.getElementById('archiveDate');
                if (dateSelect.options.length > 0 && !url.searchParams.has('date')) {
                    url.searchParams.set('date', dateSelect.value);
                }
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –¥–∞—Ç—ã
                document.getElementById('archiveControls').classList.remove('show');
                url.searchParams.delete('date');
            }
            
            window.location.href = url.toString();
        }
        
        // –î–û–ë–ê–í–õ–ï–ù–û: –∑–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ö–∏–≤–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –¥–∞—Ç—ã
        function loadArchive() {
            const date = document.getElementById('archiveDate').value;
            const url = new URL(window.location.href);
            url.searchParams.set('mode', 'archive');
            url.searchParams.set('date', date);
            window.location.href = url.toString();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        document.addEventListener('DOMContentLoaded', function() {
            const mode = new URLSearchParams(window.location.search).get('mode') || 'current';
            
            if (mode === 'archive') {
                document.getElementById('archiveControls').classList.add('show');
            }
            
            // –¢–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ current —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            if (mode === 'current') {
                document.querySelectorAll('.editable').forEach(cell => {
                    cell.addEventListener('click', function() {
                        const field = this.getAttribute('data-field');
                        
                        // üîí –ó–ê–ü–†–ï–¢ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
                        if (field === 'boiler_model' || field === 'equipment_year') {
                            return;
                        }
                        
                        const id = this.getAttribute('data-id');
                        const currentValue = this.textContent;
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = currentValue;
                        
                        input.addEventListener('blur', function() {
                            const newValue = this.value;
                            fetch('/update', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ field: field, value: newValue, id: id })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'ok') {
                                    cell.textContent = newValue;
                                } else {
                                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                                }
                            })
                            .catch(error => {
                                console.error('–û—à–∏–±–∫–∞:', error);
                                alert('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                            });
                        });
                        
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') this.blur();
                        });
                        
                        this.innerHTML = '';
                        this.appendChild(input);
                        input.focus();
                    });
                });
            }
        });
    </script>
</body>
</html>
